# TTS Refactoring & Voice Customization Plan

This plan addresses the need to handle platform-specific TTS formatting (specifically for MacOS Eloquence vs. others) and enables voice customization in the settings.

## 1. Data Structure Definition
We will define a structured input type for the `speak` function to decouple the content from its string representation.

```typescript
// src/types.ts or inside audio.ts
export interface TTSPayload {
  type: 'text' | 'pinyin';
  content: string; // The base content (e.g., "hao", "nv", "Hello")
  tone?: number;   // For pinyin: 0-5
}
```

## 2. TTS Formatter Service
Create a new file `src/services/ttsFormatter.ts` to handle the conversion of `TTSPayload` to a string based on the selected voice.

*   **Logic**:
    *   **Eloquence Voices** (`voiceURI` contains "eloquence"):
        *   Convert `v` or `ü` → `uu`.
        *   Convert neutral tone (5) → `0`.
    *   **Standard/Siri Voices**:
        *   Convert `v` → `ü` (or `u` based on further testing/defaults).
        *   Convert neutral tone (0) → `5`.
*   This centralizes the "dirty" logic of platform compatibility.

## 3. Refactor AudioService
Update `src/services/audio.ts`:

*   **State Management**: Add property to store the currently selected `SpeechSynthesisVoice`.
*   **Method Update**: Change `speak(text: string, ...)` to `speak(payload: string | TTSPayload, ...)`.
    *   If `payload` is structured, call `ttsFormatter` with the current voice's URI to get the string.
*   **Voice Management**: Add methods `getVoices()` and `setVoice(voiceURI: string)`.

## 4. Update Settings UI
Update `src/App.tsx`:

*   **State**: Add state for `selectedVoiceURI`.
*   **Effect**: Load available voices on mount (handling `onvoiceschanged`) and load user preference from `localStorage`.
*   **UI**: Add a `<select>` dropdown in the Settings modal to list Chinese (`zh-CN`) and English (`en-US`) voices.
*   **Integration**: When calling `audioService.speak`, pass the structured `TTSPayload` instead of manually formatted strings.

## Execution Steps
1.  Create `src/services/ttsFormatter.ts`.
2.  Update `src/services/audio.ts` to support voice selection and structured input.
3.  Update `src/App.tsx` and `src/hooks/useInputBuffer.ts` to use the new API.
4.  Add Voice Selector to the Settings interface.
5.  Verify with Eloquence and standard voices if possible (or at least verify the string output logic).
